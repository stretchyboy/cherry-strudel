<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABC ‚Üí Strudel - Cherry Strudel</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/abcjs-audio.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    nav {
      margin-bottom: 20px;
    }
    nav a {
      color: #d35f00;
      text-decoration: none;
    }
    nav a:hover {
      color: #ff8533;
      text-decoration: underline;
    }
    h1 {
      color: #d35f00;
    }
    h2 {
      color: #d35f00;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }

    .controls select {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: #1a1a1a;
      color: #e0e0e0;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
    }
    label {
      font-weight: 600;
      color: #d35f00;
    }
    .row {
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      background: #2a2a2a;
      color: #e0e0e0;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    button {
      background: #d35f00;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
    }
    button:hover {
      background: #ff8533;
    }
    #abc-controls {
      margin-bottom: 10px;
      background: #2a2a2a;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #3a3a3a;
    }
    #paper {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 10px;
    }
    strudel-editor {
      margin: 20px 0;
    }
  </style>
</head>

<body>

  <script src="https://unpkg.com/@strudel/repl@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.js"></script>
  <script defer src="abc2strudel.js"></script>

  <nav>
    <a href="index.html">‚Üê Back to Cherry Strudel üçí</a>
    <span style="float: right;">
      <a href="https://github.com/stretchyboy/cherry-strudel" target="_blank">GitHub</a>
    </span>
  </nav>

  <h1>ABC ‚Üí Strudel</h1>
  <p>Paste a ABC melody. Each bar becomes one Strudel cycle.</p>
  <p>The drop down contains Christmas Carols, but lots of ABC tunes will work.</p>
  
  <div class="controls">
    <label for="tune-select">Load from library:</label>
    <select id="tune-select">
      <option value="">-- Select a tune --</option>
    </select>
  </div>

  <div class="controls">
    <label for="file-upload">Upload ABC file:</label>
    <input type="file" id="file-upload" accept=".abc,.txt" />
  </div>

  <div class="controls">
    <label for="url-input">Or load from URL:</label>
    <input type="text" id="url-input" placeholder="https://example.com/tune.abc" style="flex: 1; padding: 6px 10px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #3a3a3a; border-radius: 4px;" />
    <button id="load-url">Load URL</button>
  </div>

  <div class="row">
    <textarea id="abc">

X: 25
T: Jingle Bells
P: piffero primo c0050
O: James Pierpont
%R: march
F: http://ancients.sudburymuster.org/mus/col/pdf/carolsF.pdf
Z: 2020 John Chambers <jc:trillian.mit.edu>
M: 4/4
L: 1/4
K: G
% - - - - - - - - - -
[|\
DB AG | D3 D/D/ | DB AG | E4 |\
Ec BA | F3 F | dd cA | B3 D ||\
DB AG | D3 D/D/ | DB AG |
E3 E |\
Ec BA | dd dd | ed cA | G3 z |[|\
BB B2 | BB B2 | Bd GA | B4 |\
cc cc | cB BB/B/ |
BA AB | A>z d2 ||\
BB B2 | BB B2 | Bd GA | B4 |\
cc cc | cB BB/B/ | dd cA | G3 z |]
%% - - - - - - - - - -
        </textarea>
    <button id="convert">Convert to Strudel</button>
  </div>

  <h2>Strudel Output</h2>
  <strudel-editor show-controls="true"></strudel-editor>
  
  <h2>ABC Notation</h2>
  <div id="abc-controls"></div>
  <div id="paper"></div>

  <script>
    // Load Christmas_Carols.abc and populate the dropdown
    fetch('Christmas_Carols.abc')
      .then(response => response.text())
      .then(abcText => {
        // Parse tunes: find X: headers and corresponding T: titles
        const tunes = [];
        const lines = abcText.split('\n');
        let currentX = null;
        let currentT = null;
        let tuneStart = 0;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.startsWith('X:')) {
            // if we have a previous tune, save it
            if (currentX !== null) {
              tunes.push({
                x: currentX,
                title: currentT || `Tune ${currentX}`,
                start: tuneStart,
                end: i
              });
            }
            currentX = line.substring(2).trim();
            tuneStart = i;
            currentT = null;
          } else if (line.startsWith('T:')) {
            currentT = line.substring(2).trim();
          }
        }
        // save the last tune
        if (currentX !== null) {
          tunes.push({
            x: currentX,
            title: currentT || `Tune ${currentX}`,
            start: tuneStart,
            end: lines.length
          });
        }

        // Populate the dropdown
        const select = document.getElementById('tune-select');
        for (const tune of tunes) {
          const option = document.createElement('option');
          option.value = tune.x;
          option.textContent = `${tune.x}: ${tune.title}`;
          option.dataset.start = tune.start;
          option.dataset.end = tune.end;
          select.appendChild(option);
        }

        // Handle selection changes
        select.addEventListener('change', function () {
          const selectedOption = this.options[this.selectedIndex];
          if (!selectedOption.value) return;

          const start = parseInt(selectedOption.dataset.start);
          const end = parseInt(selectedOption.dataset.end);
          const tuneText = lines.slice(start, end).join('\n');

          document.getElementById('abc').value = tuneText;
        });

        // Store for later use
        window.allTunes = tunes;
        window.allLines = lines;
      })
      .catch(err => console.error('Failed to load Christmas_Carols.abc:', err));

    // Handle file upload
    document.getElementById('file-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('abc').value = event.target.result;
      };
      reader.readAsText(file);
    });

    // Handle URL loading
    document.getElementById('load-url').addEventListener('click', function() {
      const url = document.getElementById('url-input').value.trim();
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      // Try direct fetch first
      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load URL');
          return response.text();
        })
        .then(abcText => {
          document.getElementById('abc').value = abcText;
          document.getElementById('url-input').value = '';
        })
        .catch(err => {
          // If CORS error, try with proxy
          console.log('Direct fetch failed, trying CORS proxy...', err);
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
          
          fetch(proxyUrl)
            .then(response => {
              if (!response.ok) throw new Error('Failed to load URL through proxy');
              return response.text();
            })
            .then(abcText => {
              document.getElementById('abc').value = abcText;
              document.getElementById('url-input').value = '';
            })
            .catch(proxyErr => {
              console.error('Error loading URL:', proxyErr);
              alert('Failed to load URL. The server may not allow cross-origin requests. Try downloading the file and using the file upload option instead.');
            });
        });
    });

    // Initialize ABCJS with playback controls
    if (typeof ABCJS !== 'undefined') {
      const abcTextarea = document.getElementById('abc');
      const paper = document.getElementById('paper');

      let synthControl = null;

      function renderAbc() {
        const abcText = abcTextarea.value;
        if (!abcText.trim()) return;

        // Clear previous rendering
        paper.innerHTML = '';

        // Render ABC notation
        const visualObj = ABCJS.renderAbc(paper, abcText, {
          responsive: "resize"
        })[0];

        // Create synth control if not exists
        if (synthControl) {
          synthControl.destroy();
        }

        synthControl = new ABCJS.synth.SynthController();
        synthControl.load("#abc-controls", null, {
          displayLoop: true,
          displayRestart: true,
          displayPlay: true,
          displayProgress: true,
          displayWarp: true
        });

        synthControl.setTune(visualObj, false).then(() => {
          console.log("Audio successfully loaded for ABC tune");
        }).catch(error => {
          console.warn("Couldn't load audio for ABC tune:", error);
        });
      }

      // Re-render on textarea change
      abcTextarea.addEventListener('input', renderAbc);

      // Initial render
      renderAbc();
    }
  </script>

</body>

</html>
